import e from"https";const t=require("debug")("ga4node"),a=(e,t)=>"string"==typeof e?e.substring(0,t):e,n=e=>"number"==typeof e&&!isNaN(e),i=()=>Math.floor(1*new Date/1e3),o=()=>{let e;return"undefined"!=typeof window&&void 0!==window.document?e="browser":"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node&&(e="node"),e},r=(...e)=>{t.log(...e)},s=(e,t)=>{try{e=e.toString()}catch(e){}return(e=>null!=e&&"string"==typeof e)(e)&&t&&n(t)?a(e,t):e},_={_em:"em",event_name:"en",protocol_version:"v",_page_id:"_p",_is_debug:"_dbg",tracking_id:"tid",hit_count:"_s",user_id:"uid",client_id:"cid",page_location:"dl",language:"ul",firebase_id:"_fid",traffic_type:"tt",ignore_referrer:"ir",screen_resolution:"sr",global_developer_id_string:"gdid",redact_device_info:"_rdi",geo_granularity:"_geo",_is_passthrough_cid:"gtm_up",_is_linker_valid:"_glv",_user_agent_architecture:"uaa",_user_agent_bitness:"uab",_user_agent_full_version_list:"uafvl",_user_agent_mobile:"uamb",_user_agent_model:"uam",_user_agent_platform:"uap",_user_agent_platform_version:"uapv",_user_agent_wait:"uaW",_user_agent_wow64:"uaw",error_code:"ec",session_id:"sid",session_number:"sct",session_engaged:"seg",page_referrer:"dr",page_title:"dt",currency:"cu",campaign_content:"cc",campaign_id:"ci",campaign_medium:"cm",campaign_name:"cn",campaign_source:"cs",campaign_term:"ck",engagement_time_msec:"_et",event_developer_id_string:"edid",is_first_visit:"_fv",is_new_to_site:"_nsi",is_session_start:"_ss",is_conversion:"_c",euid_mode_enabled:"ecid",non_personalized_ads:"_npa",create_google_join:"gaz",is_consent_update:"gsu",user_ip_address:"uip",google_consent_state:"gcs",google_consent_update:"gcu",us_privacy_string:"uip",document_location:"dl",document_path:"dp",document_title:"dt",document_referrer:"dr",user_language:"ul",document_hostname:"dh",item_id:"id",item_name:"nm",item_brand:"br",item_category:"ca",item_category2:"c2",item_category3:"c3",item_category4:"c4",item_category5:"c5",item_variant:"va",price:"pr",quantity:"qt",coupon:"cp",item_list_name:"ln",index:"lp",item_list_id:"li",discount:"ds",affiliation:"af",promotion_id:"pi",promotion_name:"pn",creative_name:"cn",creative_slot:"cs",location_id:"lo",id:"id",name:"nm",brand:"br",variant:"va",list_name:"ln",list_position:"lp",list:"ln",position:"lp",creative:"cn"},d=["add_payment_info","add_shipping_info","add_to_cart","remove_from_cart","view_cart","begin_checkout","select_item","view_item_list","select_promotion","view_promotion","purchase","refund","view_item","add_to_wishlist"],c=(t,a,n="browser",i={})=>{const o=new URLSearchParams(JSON.parse(JSON.stringify(a))).toString();if("browser"===n)navigator?.sendBeacon([t,o].join("?"));else{const a={headers:{"User-Agent":i.user_agent},timeout:500},n=[t,o].join("?");r("Sending request",n);const s=e.get(n,a,(e=>{e.on("data",(e=>{})),e.on("end",(()=>{}))})).on("error",(e=>{r("Error: "+e.message)}));s.on("timeout",(()=>{s.destroy()}))}},l="0.0.4",u=function(e,t={}){if(!e)throw"Tracker initialization aborted: missing tracking ids";const r=Object.assign({version:l,debug:!1,mode:o()||"browser",measurement_ids:null,queueDispatchTime:5e3,queueDispatchMaxEvents:10,queue:[],eventParameters:{},persistentEventParameters:{},userProperties:{},user_agent:`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 [GA4MP/${l}]`,user_ip_address:null,hooks:{beforeLoad:()=>{},beforeRequestSend:()=>{}},endpoint:"https://www.google-analytics.com/g/collect",payloadData:{}},t);if(r.payloadData.protocol_version=2,r.payloadData.tracking_id=Array.isArray(e)?e:[e],r.payloadData.client_id=t.client_id?t.client_id:[Math.floor(2147483648*Math.random()+0),i()].join("."),r.payloadData._is_debug=t.debug?1:void 0,r.payloadData.non_personalized_ads=t.non_personalized_ads?1:void 0,r.payloadData.hit_count=1,r.payloadData.session_id=t.session_id?t.session_id:i(),r.payloadData.session_number=t.session_number?t.session_number:1,r.payloadData.user_id=t.user_id?a(t.user_id,256):void 0,r.payloadData.user_ip_address=t.user_ip_address?t.user_ip_address:void 0,r.userAgent=`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 [GA4MP/${l}]`,"node"===r&&t.user_agent&&(r.user_agent=t.user_agent),"browser"===r.mode){const e={page_location:document.location.href,page_referrer:document.referrer,page_title:document.title,language:(navigator&&(navigator.language||navigator.browserLanguage)||"").toLowerCase(),screen_resolution:(window.screen?window.screen.width:0)+"x"+(window.screen?window.screen.height:0)};e&&(r.payloadData=Object.assign(r.payloadData,e))}return{version:r.version,mode:r.mode,getHitIndex:()=>r.payloadData.hit_count,getSessionId:()=>r.payloadData.session_id,getClientId:()=>r.payloadData.client_id,setUserProperty:(e,t)=>{e=s(e,24),t=s(t,36),r.userProperties[e]=t},setEventsParameter:(e,t)=>{if((a=t)&&("[object Function]"===Object.prototype.toString.call(a)||"function"==typeof a&&"[object RegExp]"!==Object.prototype.toString.call(a)))try{t=t()}catch(e){}var a;e=s(e,40),t=s(t,100),r.persistentEventParameters[e]=t},setUserId:e=>{r.payloadData.user_id=s(e,256)},trackEvent:(e,t={},a={},i=!0)=>{var o;(o=r?.mode,"node"===o||"undefined"==typeof window||"undefined"!=typeof window&&!("navigator"in window)?new Promise((e=>{e(null)})):navigator?.userAgentData?.getHighEntropyValues?navigator.userAgentData.getHighEntropyValues(["platform","platformVersion","architecture","model","uaFullVersion","bitness","fullVersionList","wow64"]).then((e=>({_user_agent_architecture:e.architecture,_user_agent_bitness:e.bitness,_user_agent_full_version_list:encodeURIComponent((Object.values(e.fullVersionList)||navigator?.userAgentData?.brands).map((e=>[e.brand,e.version].join(";"))).join("|")),_user_agent_mobile:e.mobile?1:0,_user_agent_model:e.model||navigator?.userAgentData?.mobile,_user_agent_platform:e.platform||navigator?.userAgentData?.platform,_user_agent_platform_version:e.platformVersion,_user_agent_wow64:e.wow64?1:0}))):new Promise((e=>{e(null)}))).then((a=>{a&&(r.payloadData=Object.assign(r.payloadData,a));const o=((e,t)=>{const a={};1===r.payloadData.hit_count&&(r.payloadData.session_engaged=1),Object.entries(r.payloadData).forEach((e=>{const t=e[0],n=e[1];_[t]&&(a[_[t]]="boolean"==typeof n?+n:n)}));const i=Object.assign(JSON.parse(JSON.stringify(r.persistentEventParameters)),JSON.parse(JSON.stringify(t)));return i.event_name=e,Object.entries(i).forEach((t=>{const i=t[0],o=t[1];if("items"===i&&d.indexOf(e)>-1&&Array.isArray(o)){let e=o.slice(0,200);for(let t=0;t<e.length;t++)if(e[t]){const n={core:{},custom:{}};Object.entries(e[t]).forEach((e=>{_[e[0]]?void 0!==e[1]&&(n.core[_[e[0]]]=e[1]):n.custom[e[0]]=e[1]}));let i=Object.entries(n.core).map((e=>e[0]+e[1])).join("~")+"~"+Object.entries(n.custom).map(((e,t)=>{var a=10>t?""+t:String.fromCharCode(65+t-10);return`k${a}${e[0]}~v${a}${e[1]}`})).join("~");a[`pr${t+1}`]=i}}else _[i]?a[_[i]]="boolean"==typeof o?+o:o:a[(n(o)?"epn.":"ep.")+i]=o})),Object.entries(r.userProperties).forEach((e=>{const t=e[0],i=e[1];_[t]?a[_[t]]="boolean"==typeof i?+i:i:a[(n(i)?"upn.":"up.")+t]=i})),a})(e,t);if(o&&i){for(let e=0;e<o.tid.length;e++){let t=JSON.parse(JSON.stringify(o));t.tid=o.tid[e],c(r.endpoint,t,r.mode,{user_agent:r?.user_agent})}r.payloadData.hit_count++}else r.queue.push(event)>=r.queueDispatchMaxEvents&&(r.queue=[])}))}}};export{u as default};
